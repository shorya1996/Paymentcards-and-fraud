%macro fillrate_all_vars(data=);

    /* Step 1: Get variable info */
    proc contents data=&data out=varinfo(keep=name type) noprint;
    run;

    /* Step 2: Separate numeric and character variables */
    proc sql noprint;
        select name into :num_vars separated by ' '
        from varinfo where type = 1;

        select name into :char_vars separated by ' '
        from varinfo where type = 2;
    quit;

    /* Step 3: Get total number of rows */
    %let dsid = %sysfunc(open(&data));
    %let total = %sysfunc(attrn(&dsid, nobs));
    %let rc = %sysfunc(close(&dsid));

    /* Step 4: Missing count for numeric variables using PROC MEANS */
    %if "&num_vars" ne "" %then %do;
        proc means data=&data noprint;
            var &num_vars;
            output out=num_stats n= / autoname;
        run;

        data num_fill;
            set num_stats;
            length variable $32 type $9;
            array n_vars n_:;
            do i = 1 to dim(n_vars);
                variable = scan(vname(n_vars[i]), 2, '_');
                type = "Numeric";
                missing = &total - n_vars[i];
                fillrate = round((n_vars[i] / &total) * 100, 0.01);
                output;
            end;
            keep variable type missing fillrate;
        run;
    %end;

    /* Step 5: Missing count for character variables using DATA step */
    %if "&char_vars" ne "" %then %do;
        data char_fill;
            set &data end=last;
            array chars {*} $ &char_vars;
            retain
                %do i=1 %to %sysfunc(countw(&char_vars));
                    miss_&sysfunc(scan(&char_vars, &i)) 0
                %end;
            ;

            %do i=1 %to %sysfunc(countw(&char_vars));
                if missing(%scan(&char_vars, &i)) then miss_%scan(&char_vars, &i) + 1;
            %end;

            if last then do;
                %do i=1 %to %sysfunc(countw(&char_vars));
                    variable = "%scan(&char_vars, &i)";
                    type = "Character";
                    missing = miss_%scan(&char_vars, &i);
                    fillrate = round((1 - (missing / &total)) * 100, 0.01);
                    output;
                %end;
            end;

            length variable $32 type $9;
            keep variable type missing fillrate;
        run;
    %end;

    /* Step 6: Combine both */
    data fillrate_result;
        set 
            %if %symexist(num_fill) or "&num_vars" ne "" %then %do; num_fill %end;
            %if %symexist(char_fill) or "&char_vars" ne "" %then %do; char_fill %end;
        ;
    run;

    proc print data=fillrate_result noobs label;
        label variable = "Variable Name"
              type     = "Type"
              missing  = "Missing Count"
              fillrate = "Fill Rate (%)";
        title "Fill Rate Report for Dataset: &data";
    run;

%mend;
